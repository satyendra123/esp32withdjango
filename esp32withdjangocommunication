# abhi ye code kaise work kar rha hai ki response = requests.post(url, data="Get_Fingerid=get_id") is data ko lekr http post mar rha hai aur mera django kya kar rha hai ki 
#ESP32 code
import time
import urequests as requests  # MicroPython module for HTTP requests

# Replace these with your network credentials
ssid = "Airtel_tejv_3002"
password = "air73137"

# Replace with your server URL
server_url = "http://192.168.1.9:8000/biometricattendance/getdata/"

def connect_wifi():
    import network
    sta_if = network.WLAN(network.STA_IF)
    if not sta_if.isconnected():
        print("Connecting to WiFi...")
        sta_if.active(True)
        sta_if.connect(ssid, password)
        while not sta_if.isconnected():
            pass
    print("Connected to WiFi")
    print("Network config:", sta_if.ifconfig())

def check_to_add_id():
    url = server_url + "check_add_id/"
    print("Requesting URL:", url)
    
    response = requests.post(url, data="Get_Fingerid=get_id")
    
    if response.status_code == 200:
        print("HTTP Response code:", response.status_code)
        payload = response.json()
        print("Payload:", payload)
        
        if payload.get("response", "").startswith("add-id"):
            add_id = int(payload["response"].split("add-id")[-1])
            print("Add ID:", add_id)
            get_fingerprint_enroll(add_id)
    else:
        print("Error in HTTP request:", response.status_code)
    
    response.close()

def check_to_delete_id():
    url = server_url + "check_delete_id/"
    print("Requesting URL:", url)
    
    response = requests.post(url, data="Action=check")
    
    if response.status_code == 200:
        print("HTTP Response code:", response.status_code)
        payload = response.json()
        print("Payload:", payload)
        
        if payload.get("response", "").startswith("del-id"):
            delete_id = int(payload["response"].split("del-id")[-1])
            print("Delete ID:", delete_id)
            delete_fingerprint(delete_id)
    else:
        print("Error in HTTP request:", response.status_code)
    
    response.close()

def check_to_update_id():
    url = server_url + "check_update_id/"
    print("Requesting URL:", url)
    
    response = requests.post(url, data="Action=check")
    
    if response.status_code == 200:
        print("HTTP Response code:", response.status_code)
        payload = response.json()
        print("Payload:", payload)
        
        if payload.get("response", "").startswith("update-id"):
            update_id = int(payload["response"].split("update-id")[-1])
            print("Update ID:", update_id)
            update_fingerprint(update_id)
    else:
        print("Error in HTTP request:", response.status_code)
    
    response.close()

def delete_fingerprint(id):
    # Dummy implementation, replace with your actual code
    print("Fingerprint ID", id, "deleted.")

def add_fingerprint(id):
    # Dummy implementation, replace with your actual code
    print("Fingerprint ID", id, "added.")

def update_fingerprint(id):
    # Dummy implementation, replace with your actual code
    print("Fingerprint ID", id, "updated.")

def get_fingerprint_enroll(id):
    # Dummy implementation, replace with your actual code
    print("Enrolling Fingerprint ID", id, ".")

def main():
    connect_wifi()
    
    while True:
        check_to_add_id()
        check_to_delete_id()
        check_to_update_id()
        time.sleep(10)  # Check actions every 10 seconds

if __name__ == "__main__":
    main()

# django code 
from django.shortcuts import render
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt

@csrf_exempt
def fingerprint_actions(request):
    if request.method == 'POST':
        print("data is comming" "+" ,request.POST)
        if 'FingerID' in request.POST:
            FingerID = request.POST['FingerID']
            if FingerID == "1": 
                return JsonResponse({'response': 'loginuser_name1'})
            else:
                return JsonResponse({'response': 'logoutuser_name' + FingerID})
            
        elif request.POST.get('DeleteID') == 'check':
            return JsonResponse({'response': 'del-id123'})
        
        elif request.POST.get('Get_Fingerid') == 'get_id':
            return JsonResponse({'response': 'add-id123'})

        elif 'confirm_id' in request.POST:
            confirm_id = request.POST['confirm_id']
            return JsonResponse({'response': 'ID ' + confirm_id + ' added'})
        
    return JsonResponse({'response': 'only POST allowed'})

#urls.py code
# Add the following to your Django urls.py
from django.urls import path
from . import views

urlpatterns = [
    # Other URL patterns
    path('biometricattendance/getdata/check_add_id/', views.fingerprint_actions, name='check_add_id'),
    path('biometricattendance/getdata/check_delete_id/', views.fingerprint_actions, name='check_delete_id'),
    path('biometricattendance/getdata/check_update_id/', views.fingerprint_actions, name='check_update_id'),
]

#main urls.py code
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('attendance.urls')),
]


